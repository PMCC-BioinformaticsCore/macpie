% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/select_robust_controls.R
\name{select_robust_controls}
\alias{select_robust_controls}
\title{Select high-quality control replicates via TMMwsp log-CPM correlation}
\usage{
select_robust_controls(
  data,
  samples,
  orig_ident,
  cpm_filter = 1,
  min_samps = 16,
  corr_method = c("spearman", "pearson"),
  top_n = 5,
  make_plots = TRUE
)
}
\arguments{
\item{data}{A tidyseurat object containing an RNA assay with a \strong{counts} layer.}

\item{samples}{the control/treatment label to keep in column samples
(e.g., "CB_43_EP73_0"). Only cells/samples with this label are considered.}

\item{orig_ident}{Character scalar: the plate/batch identifier to keep
(e.g., "VH02012942"). Only cells/samples from this batch are considered.}

\item{cpm_filter}{Numeric scalar; CPM threshold used for gene filtering prior to
normalization (default 1).}

\item{min_samps}{Integer; a gene must be expressed (CPM > cpm_filter) in at least
this many samples to be retained (default 16).}

\item{corr_method}{Correlation type used for ranking; one of
c("spearman","pearson") (default "spearman").}

\item{top_n}{Integer; the number of top-ranked samples to report in topN.
Ties at the cutoff are kept (default 5).}

\item{make_plots}{Logical; if TRUE, print a log2-CPM boxplot and Pearson/Spearman
correlation heatmaps (default TRUE).}
}
\value{
A list with elements:
\itemize{
\item subset_obj: The Seurat object subset used for analysis.
\item dge: The filtered edgeR::DGEList
\item log_cpm_tmm: Matrix of TMMwsp log2-CPM.
\item boxplot_df: Long-format data frame used for the boxplot (gene, sample, log_cpm).
\item cor_pearson: Sample-sample Pearson correlation matrix.
\item cor_spearman: Sample-sample Spearman correlation matrix.
\item ranking_method: The correlation method used for ranking.
\item scores_mean_to_others: Named numeric vector of mean Fisher-z back-transformed
correlations (higher = better), sorted decreasing.
\item topN: Named numeric vector of the top-ranked samples (ties at the cutoff kept).
}
}
\description{
For a given control group (e.g., DMSO) on a specific plate/batch, this function
ranks samples by their average correlation (Fisher z-averaged) to all \emph{other}
samples using edgeR's TMMwsp-normalized log2-CPM. It returns the ranking and (optionally)
plots per-sample expression distributions and sample-sample correlation heatmaps.
}
\details{
Workflow:
\enumerate{
\item Subset to the specified samples and orig_ident (plate/batch).
\item Build an edgeR::DGEList, filter lowly expressed genes using CPM and min_samps.
\item Normalize with TMMwsp and compute log2-CPM.
\item Rank samples by mean Fisher z transformed correlation to all other samples
(according to corr_method).
\item Return the ranking, correlation matrices, the normalized matrix, and (optionally)
plots for QC.
}

Column names of the counts matrix are rewritten to "<orig.ident>_<Well_ID>"
for easier visual inspection in plots.
}
\examples{
data(mini_mac)
res <- select_robust_controls(mini_mac,samples = "DMSO_0", orig_ident = "PMMSq033_mini")


}
