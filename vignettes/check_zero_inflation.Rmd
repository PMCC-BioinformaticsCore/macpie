---
title: "Check for zero-inflation in your data"
output:
  rmarkdown::html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{check_zero_inflation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteBuild{true}
  
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  digits = 3
)
options(digits = 3) 
```



## Overview 

This is a quick demonstration of the `check_zeroinflation()` function from our **macpie** package. This function is a fast diagnostic tool to help you assess whether your MACseq data exhibits zero-inflation relative to a negative binomial (NB) model.

We will use a lightweight convenience wrapper `subsample_genes()` around **`seqgendiff::select_counts()`** to create a smaller object with a subset of genes for faster computation. This function is also part of the **macpie** package. 

Under the hood, `check_zeroinflation()` uses **edgeR** to estimate gene-wise dispersions and compute expected zero probabilities under a NB model. It then compares the observed and expected zero-inflated indexes for each gene within each group defined in the metadata.

This function:

  - estimates gene-wise tagwise dispersions with edgeR (using all selected groups),

  - builds NB-expected zero probabilities from TMMwsp-scaled means, and

  - returns per-gene ZI (observed zeros minus NB-expected zeros) and per-group summaries (e.g., % genes with ZI > 0.05). ZI-cutoffs are user-defined.
  

The output is a list with two elements:

  - `summary_by_group`: A summary table showing the number and percentage of genes that are zero-inflated for each group at specified cutoffs.
  
  - `gene_metrics_by_group`: A detailed table with gene-wise metrics, including observed and expected zero numbers and proportions, zero-inflation index (ZI), mean count, and dispersion estimates for each gene in each group.

**Note**: `check_zeroinflation()` relies on edgeR to estimate dispersion. The current implementation requires ≥2 groups in the design so that edgeR can stabilize gene-wise dispersions across groups. If you only have a single group and still want a design-aware baseline for expected zeros, fit a Gamma–Poisson/NB GLM and compute the expected zero probabilities from its fitted means and over-dispersion.

***
<br>

```{r set_wd, include=FALSE}
dir <- "/Users/liuxin/macpie_Dev/"
devtools::load_all(paste0(dir, "macpie/"))
```

## Load data

Load data and preprocess before subsampling genes and checking for zero-inflation.

```{r setup}
#install.packages("macpie")  # or devtools::install_github("PMCC-BioinformaticsCore/macpie")
library(macpie)

# Define project variables
project_name <- "PMMSq033"
project_metadata <- system.file("extdata/PMMSq033_metadata.csv", package = "macpie")
# Load metadata
metadata <- read_metadata(project_metadata)

```

```{r load_data}
# Import raw data
project_rawdata <- paste0(dir, "/macpieData/PMMSq033/raw_matrix")
project_name <- "PMMSq033"
raw_counts <- Read10X(data.dir = project_rawdata)
# Create tidySeurat object
mac <- CreateSeuratObject(counts = raw_counts,
                          project = project_name,
                          min.cells = 1,
                          min.features = 1)
# Join with metadata
mac <- mac %>%
  inner_join(metadata, by = c(".cell" = "Barcode"))
# Add unique identifier
mac <- mac %>%
  mutate(combined_id = str_c(Compound_ID, Concentration_1, sep = "_")) %>%
  mutate(combined_id = gsub(" ", "", .data$combined_id))
mac <- mac %>%
  filter(Project == "Current")

```

Filter genes with very low counts across all samples. This step is important because genes with extremely low expression can lead to unreliable estimates of dispersion and expected zero probabilities, which can skew the zero-inflation assessment.

```{r}
# Filter by read count per sample group
mac <- filter_genes_by_expression(mac, 
                                  group_by = "combined_id", 
                                  min_counts = 10, 
                                  min_samples = 2)
```


## Subsample genes for faster computation

This is to randomly select a subset of 1000 genes for a quick check. For a more comprehensive analysis, consider using a larger subset.

```{r}
# Subsample genes for faster computation
sub_mac <- subsample_genes(mac, ngene = 1000, gselect = "random", seed = 1)
sub_mac %>% nrow()
```


## Check for zero-inflation  

We can now run the zero-inflation check on the subsampled data.

### DMSO vs Camptothecin

First, we will compare two groups: "DMSO_0" and "CAMPTOTHECIN_10".


  
```{r}
zi_results <- check_zeroinflation(sub_mac, 
                                  group_by = "combined_id",
                                  samples = c("DMSO_0","CAMPTOTHECIN_10"),
                                  batch = 1,
                                  cutoffs = c(0.1, 0.2))

```

#### View gene-wise metrics for each group

For DMSO group: 

```{r}
zi_results$gene_metrics_by_group %>% filter(group=="DMSO_0") %>% head()
```

For Camptothecin group:

```{r}
zi_results$gene_metrics_by_group %>% filter(group=="CAMPTOTHECIN_10") %>% head()
```

#### View summary statistics for each group

```{r}
zi_results$summary_by_group
```


From the summary table, we can see the summary statistics for each group, including the number and percentage of genes that are zero-inflated at the specified cutoffs.

Each of the columns in the summary table are defined as follows:

  - group: The treatment group
  
  - n_genes: Total number of genes analyzed in the group
  
  - n_wells:  Total number of wells/samples in the group
  
  - median_p0_obs: Median observed zero proportion across genes in the group
  
  - median_p0_nb: Median expected zero proportion under the NB model across genes in the group
  
  - median_ZI: Median zero-inflation index (ZI = p0_nb - p0_obs for each gene) across genes in the group
  
  - observed_zeros_num: Number of data points with observed zeros (it shouldn't be more than n_genes*n_wells for each group)
  
  - expected_zeros_num: Number of data points with expected zeros under the NB model (same here, it shouldn't be more than n_genes*n_wells for each group)
  
  - pct_ZI_gt_0.1: Percentage of genes with ZI greater than 0.1
  
  - pct_ZI_gt_0.2: Percentage of genes with ZI greater than 0.2

***  
<br> 

#### See below for interpretation of the results

For DMSO vs camptothecin, we can see that both DMSO and camptothecin groups have negative median ZI values, indicating that there is no significant zero-inflation in either group. Percentage of genes with ZI greater than 0.1 or 0.2 are 13.5% and 6.6% for camptothecin. As camptothecin acts as a DNA topoisomerase inhibitor and induces DNA damage, it can lead to cell cycle arrest and apoptosis, which may reduce the overall transcriptional activity in the cells. This reduction in transcriptional activity can result in genes being expressed at lower levels or not at all. On the other hand, DMSO is a common solvent used in biological experiments and is not expected to induce significant changes in gene expression. Therefore, it is reasonable to observe a lower level of zero-inflation in the DMSO group compared to the camptothecin group. Same as ZI results for DMSO, the percentage of genes with ZI greater than 0.1 or 0.2 are both 0%.

Besides, the observed zeros are also lower than the expected zeros, further supporting the absence of zero-inflation. Overall, these results suggest that the data does not exhibit significant zero-inflation, and a standard negative binomial model may be appropriate for downstream analyses. Zero-inflated models (ZINB) may not be necessary for this dataset.



```{r, include=FALSE}
rm(zi_results)
```

***
<br>
  
  
  
### DMSO vs Staruosporine 
  
Next, we will compare two treatment groups: "DMSO_0" and "Staurosporine_10". As staurosporine is a potent inducer of apoptosis, we might expect to see more zero-inflation in this group compared to DMSO.


```{r}
# Check for zero-inflation
zi_results <- check_zeroinflation(sub_mac, 
                                  group_by = "combined_id",
                                  samples = c("DMSO_0","Staurosporine_10"),
                                  batch = 1,
                                  cutoffs = c(0.1, 0.2))
```


#### View gene-wise metrics for each group

For DMSO group: 

```{r}
zi_results$gene_metrics_by_group %>% filter(group=="DMSO_0") %>% head()
```

For Staurosporine group: 
```{r}
zi_results$gene_metrics_by_group %>% filter(group=="Staurosporine_10") %>% head()
```

#### View summary statistics for each group

```{r}
zi_results$summary_by_group
```
#### See below for interpretation of the results

For DMSO vs staurosporine, we can see that only staurosporine has 14% of median ZI value, the observed zeros number (713) is much higher than the expected zeros number (~355), indicating that there is some level of zero-inflation in the staurosporine group. As staurosporine is a cell death control, which it is expected to see zero-inflated data in this group. In this case, it may be appropriate to consider using a zero-inflated negative binomial (ZINB) model for downstream analyses to account for the excess zeros in the data.


