---
title: "Benchmark: runtime and memory of DMSO selection"
output: 
  rmarkdown::html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{benchmarking DMSO runtime and memory}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteBuild{true}
---

```{r set_wd, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
dir <- "/Users/liuxin/macpie_Dev/"
devtools::load_all(paste0(dir, "macpie/"))

```


```{r setup}

suppressMessages(library(macpie))
suppressMessages(library(tibble))
suppressMessages(library(stringr))
suppressMessages(library(pheatmap))
suppressMessages(library(ggiraph))
suppressMessages(library(tidyseurat))
suppressMessages(library(purrr))
suppressMessages(library(ggplot2))
suppressMessages(library(peakRAM))
suppressMessages(library(ps))

```


```{r}
options(scipen=999, digits=3)
```



```{r}
input_data_dir <- file.path(paste0(dir,"/DRUGseqData/DRUG-seq-main/data"))
meta <- read.csv(file.path(input_data_dir,'meta.csv'),stringsAsFactors = F) %>% 
  filter(plate_barcode %in% c("VH02001612", "VH02001614", "VH02001618"))
Exp<-lapply(unique(meta$batch), function(x){
  b<-unique(meta[meta$batch==x,]$plate_barcode)
  res<-lapply(b, function(y){
    load(file.path(input_data_dir, paste0("flowcell_4000_UMI_decode_",y,".RData")),verbose=T)
    annot<-meta[meta$plate_barcode==y,]
    rownames(annot) <- apply( annot[ , c('plate_barcode','well_index') ] , 1 , paste , collapse = "_" )
    UMI_decode<-UMI_decode[!rownames(UMI_decode) %in% grep("ERCC-",rownames(UMI_decode),value = T),]
    UMI_annot<-list(UMI_decode,annot)
    names(UMI_annot)<-c("UMI.counts", "Annotation")
    return(UMI_annot)
  })
  names(res)<-b
  return(res)
})
names(Exp)<-unique(meta$batch)
batch3 <- Exp$`3`
```

```{r}
metadata <- batch3 %>% 
  map_dfr(~ {
    .x$Annotation %>%
      mutate(
        Plate_ID        = plate_barcode,
        Well_ID         = plate_well,
        Barcode         = paste0(plate_barcode, "_", well_index),
        Row             = substr(plate_well, 1, 1),
        Column          = as.integer(substr(plate_well, 2, nchar(plate_well))),
        Species         = "human",
        Cell_type       = "U2OS",
        Model_type      = "2D_adherent",
        Time            = "24",
        Unit            = "h",
        Treatment_1     = treatment,
        Concentration_1 = treatment_dose,
        Unit_1          = treatment_dose_unit,
        Sample_type         = ifelse(treatment == "DMSO", "Control", "Treated")

      )
  })


metadata <- metadata%>%select(-c(plate_barcode, index, plate_replicate, plate_well,
                                 step, readout.comment, well_index, cell.line.name, 
                                 batch, treatment, treatment_dose, treatment_dose_unit, timepoint))


batch3_counts <- batch3 %>%
  map(~ {
    .x$UMI.counts %>%
      as.data.frame() %>% 
      rownames_to_column("gene_id") %>%
      separate(col = gene_id, into = c("gene_name", "chrom"), sep = ",") %>%
      mutate(gene_name = make.unique(gene_name)) %>%
      select(-chrom) %>%
      tibble::column_to_rownames(var = "gene_name") %>%
      as.matrix()
  })

binded_counts <- do.call(cbind, batch3_counts)

as_mac <- CreateSeuratObject(counts = binded_counts, 
  min.cells = 1, 
  min.features = 1)

as_mac<- as_mac%>% inner_join(metadata, by = c(".cell"="Barcode"))
as_mac$combined_id <- paste0(as_mac$Treatment_1, "_", as_mac$Concentration_1)
batch3_mac_filtered <- filter_genes_by_expression(as_mac,
                                     group_by = "combined_id",
                                     min_counts = 5,
                                     min_samples = 1)

```

```{r}
select_top_replicates_tmmcpm <- function(
  data,
  combined_id,                 # e.g. "CB_43_EP73_0"
  orig_ident,                  # e.g. "VH02012942"
  cpm_filter    = 1,           # CPM threshold for gene filtering
  min_samps     = 16,          # number of samples a gene must be expressed in
  corr_method   = c("spearman","pearson"),
  top_n         = 5,
  make_plots    = TRUE
){
  
  corr_method <- match.arg(corr_method)

  # Subset to the plate/condition of interest
  subgroup <- subset(data, subset = combined_id == !!combined_id & orig.ident == !!orig_ident)

  # Counts and human-friendly column names
  counts_d <- GetAssayData(subgroup, assay = "RNA", layer = "counts")
  well_colnames <- paste0(subgroup$orig.ident, "_", subgroup$Well_ID)
  names(well_colnames) <- rownames(subgroup@meta.data)
  colnames(counts_d) <- well_colnames[colnames(counts_d)]

  # edgeR container + gene filtering
  y <- edgeR::DGEList(counts_d, group = subgroup$orig.ident)
  keep <- rowSums(edgeR::cpm(y) > cpm_filter) >= min_samps
  y <- y[keep, , keep.lib.sizes = FALSE]

  # TMMwsp → log2-CPM
  y <- edgeR::calcNormFactors(y, method = "TMMwsp")
  log_cpm_tmm <- edgeR::cpm(y, log = TRUE, normalized.lib.sizes = TRUE)

  #  Long data for boxplot
  df_long <- as.data.frame(log_cpm_tmm) |>
    tibble::rownames_to_column(var = "gene") |>
    tidyr::pivot_longer(-gene, names_to = "sample", values_to = "log_cpm")

  if (make_plots) {
    # Boxplot
    print(
      ggplot2::ggplot(df_long, ggplot2::aes(x = sample, y = log_cpm)) +
        ggplot2::geom_boxplot(outlier.size = 0.5) +
        ggplot2::labs(x = "Sample", y = "log2 CPM",
                      title = "Boxplot of log2-CPM (TMMwsp)") +
        ggplot2::theme_classic() +
        ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, hjust = 1))
    )
  }

  # Correlation matrices
  cors_pear  <- stats::cor(log_cpm_tmm, method = "pearson")
  cors_spear <- stats::cor(log_cpm_tmm, method = "spearman")

  if (make_plots) {
    pheatmap::pheatmap(cors_pear,  main = "Sample–sample correlation (Pearson, log2-CPM)")
    pheatmap::pheatmap(cors_spear, main = "Sample–sample correlation (Spearman, log2-CPM)")
  }

  # Ranking by mean Fisher-z correlation to all *other* samples
  R <- stats::cor(log_cpm_tmm, method = corr_method, use = "pairwise.complete.obs")
  diag(R) <- NA_real_

  # clip, Fisher z, average, back-transform
  Z <- atanh(pmin(pmax(R, -0.999999), 0.999999))
  score_z <- rowMeans(Z, na.rm = TRUE)
  score_r <- tanh(score_z)

  # top-N names and scores
  ord  <- order(score_r, decreasing = TRUE, na.last = NA)
  srt <- score_r[ord]
  cutoff <- srt[top_n]              # N-th best score
  keep   <- srt >= cutoff    # keep all tied at the cutoff
  topN <- srt[keep]

  # return everything useful
  list(
    subset_obj   = subgroup,
    dge          = y,
    log_cpm_tmm  = log_cpm_tmm,
    boxplot_df   = df_long,
    cor_pearson  = cors_pear,
    cor_spearman = cors_spear,
    ranking_method = corr_method,
    scores_mean_to_others = sort(score_r, decreasing = TRUE),
    topN = topN
  )
}


```


```{r}
res1 <- peakRAM({
dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  }
)

res2 <- peakRAM({
dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  }
)

res3 <- peakRAM({
dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  }
)


```


```{r}
res1

res2

res3
```

```{r}

if (!requireNamespace("ps", quietly = TRUE)) install.packages("ps")
get_rss_mb <- function() ps::ps_memory_info(ps::ps_handle())[1] / 1024^2

rss_before <- get_rss_mb()
tm1 <- system.time({
  dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
})
rss_after  <- get_rss_mb()
cat(sprintf("Elapsed: %.1fs | RSS before→after: %.0f→%.0f MiB (Δ %.0f MiB)\n",
            tm1["elapsed"], rss_before, rss_after, rss_after - rss_before))


get_rss_mb <- function() ps::ps_memory_info(ps::ps_handle())[1] / 1024^2

rss_before <- get_rss_mb()
tm2 <- system.time({
  dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
})
rss_after  <- get_rss_mb()
cat(sprintf("Elapsed: %.1fs | RSS before→after: %.0f→%.0f MiB (Δ %.0f MiB)\n",
            tm2["elapsed"], rss_before, rss_after, rss_after - rss_before))


get_rss_mb <- function() ps::ps_memory_info(ps::ps_handle())[1] / 1024^2

rss_before <- get_rss_mb()
tm3 <- system.time({
  dmso_VH02001612 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001612",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  dmso_VH02001614 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001614",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
  
  dmso_VH02001618 <- select_top_replicates_tmmcpm(
    batch3_mac_filtered,
    combined_id = "DMSO_0",
    orig_ident  = "VH02001618",
    cpm_filter  = 5,
    min_samps   = 8,
    corr_method = "spearman",
    top_n       = 5,
    make_plots  = FALSE
  )
})
rss_after  <- get_rss_mb()
cat(sprintf("Elapsed: %.1fs | RSS before→after: %.0f→%.0f MiB (Δ %.0f MiB)\n",
            tm3["elapsed"], rss_before, rss_after, rss_after - rss_before))




```


```{r}
tm1

tm2

tm3
```


### Summary of runtime and memory usage

The `select_top_replicates_tmmcpm` function runs on same plates (VH02001612, VH02001614, VH02001618) in approximately 2.463 seconds for three plates, with a peak memory usage of around 2403 Mib. This demonstrates that the function is efficient and can be used effectively for selecting DMSO controls in a reasonable timeframe without excessive memory consumption.