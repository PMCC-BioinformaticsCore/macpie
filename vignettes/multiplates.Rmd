---
title: "macpie"
output:
  rmarkdown::html_document:
    theme: flatly
    toc: true
    toc_float: true
    toc_depth: 5
vignette: >
  %\VignetteIndexEntry{multiplates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  %\VignetteBuild{true}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```


```{r load_metadata}
devtools::load_all()


library(Seurat)
library(edgeR)
library(dplyr)
library(leidenbase)
library(gridExtra)
library(enrichR)
library(parallel)
library(mcprogress)
library(ggsci)
library(ggiraph)
library(pheatmap)
library(tidyr)
library(tibble)
library(enrichR)
library(variancePartition)
library(glmGamPoi)
library(PoiClaClu)
library(Matrix)
library(data.table)


# Define project variables
project_name <- "PMMSq033"
project_metadata <- system.file("extdata/PMMSq033/PMMSq033_metadata_drugnames.csv", package = "macpie")

# Load metadata
metadata <- read_metadata(project_metadata)
metadata$Time <- as.factor(metadata$Time)
metadata$Concentration_1 <- as.factor(metadata$Concentration_1)
colnames(metadata)

# Validate metadata
validate_metadata(metadata)

```

## Introduction 

<b>macpie</b> supports multi-plate analysis using MACseq data, with features for quality control (QC), batch correction, differential expression (DE) analysis, and pathway enrichment.

This vignette demonstrates a complete workflow for analyzing multiple plates, incorporating plate-specific batch effects. It includes:

- Loading and filtering raw count matrices from two MAC-seq plates (PMMSq033 and PMMSq034).

- Merging with metadata, constructing unique plate and sample identifiers

- Visual QC sample distribution

- Single DE comparison and Multi-DE comparisons


The results from DE comparisons can be used for any downstream analyses such as pathway/geneset enrichment and Profile similarity that we've shown in the main vignettes. 


### 1. Multi-plates analysis

This section walks through QC and differential expression analysis of two MAC-seq plates with matched layouts.


**Key points**: 

  - import two macseq plates and check QC for any batch effects (and batch correction)
  - use **compute_single_de** and **compute_multi_de** by incorporating batch factor

#### 1.1 Import data and QC

Here we import the raw count matrix and metadata for the first plate, apply QC filters, and generate the tidySeurat object.

Load PMMSq033 and PMMSq034

```{r load_two_plates}
project_metadata <- system.file("extdata/PMMSq033/PMMSq033_metadata_drugnames.csv", package = "macpie")
metadata <- read_metadata(project_metadata)

pmm33_in <- system.file("extdata/PMMSq033/raw_matrix", package = "macpie")
pmm34_in <- system.file("extdata/PMMSq034/raw_matrix", package = "macpie")
raw_counts_total <- Read10X(data.dir = c(pmm33_in,pmm34_in))
keep <- rowSums(cpm(raw_counts_total) >= 10) >= 2
raw_counts <- raw_counts_total[keep, ]
combined <- CreateSeuratObject(counts=raw_counts,
                               min.cells = 1,
                          min.features = 1)

combined[["percent.mt"]] <- PercentageFeatureSet(combined, pattern = "^mt-|^MT-")
combined[["percent.ribo"]] <- PercentageFeatureSet(combined, pattern = "^Rp[slp][[:digit:]]|^Rpsa|^RP[SLP][[:digit:]]|^RPSA")

#join with metadata
combined$Barcode <- str_replace_all(rownames(combined@meta.data),"[1|2]_","")

combined <- combined %>%
  inner_join(metadata, by = c("Barcode" = "Barcode"))

combined <- combined%>%
  filter(Project == "Current")

#add unique identifier
combined <- combined %>%
  mutate(combined_id = str_c(Treatment_1, Concentration_1, sep = "_")) %>%
  mutate(combined_id = gsub(" ", "", .data$combined_id))

combined$combined_id <- make.names(combined$combined_id)

```

```{r}
# meta <- meta %>% mutate(Treatment_1 =  ifelse(grepl("^Ada|^Shenali|^EMPTY$", Treatment_1), Treatment_1, paste0("ML_", Treatment_1)))

combined <- combined %>% mutate(orig.ident = ifelse(grepl("1", orig.ident), "PMMSq033","PMMSq034"))
```


Plate layout for both plates:


```{r, fig.width = 10, fig.height = 4}
p <- plot_plate_layout(combined, "nCount_RNA", "combined_id") + facet_wrap(~orig.ident)
girafe(ggobj = p, 
  fonts = list(sans = "sans"),
  options = list(
    opts_hover(css = "stroke:black; stroke-width:1px;")
  ))

```



We visualize sample grouping across plates using MDS (multidimensional scaling) plots and assess expression variability using RLE plots.

```{r}
combined_dmso <- combined %>%
  filter(Treatment_1 == "DMSO")
```

```{r multi_plates_plot_mds, fig.width = 8, fig.height = 4}
plot_mds(combined, group_by = "orig.ident", label = "combined_id", n_labels = 30)
plot_mds(combined_dmso, group_by = "orig.ident", label = "combined_id", n_labels = 30)
```

RLE plots to show before and after using limma_voom for batch correction.  


```{r multi_plates_plot_rle, fig.width = 8, fig.height = 4}
plot_rle(combined_dmso, label_column = "orig.ident", normalisation = "raw") + scale_x_discrete(drop = FALSE) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot_rle(combined_dmso, label_column = "orig.ident", normalisation = "limma_voom") + scale_x_discrete(drop = FALSE) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

#### 1.2 Single comparison DE analysis 

We run differential expression using edgeR between one treatment condition and control (e.g. Staurosporine_0.1 vs DMSO_0), while accounting for plate effects via batch modeling.

First, we look at the volcano plot if no batch correction is used.

```{r multi_plates_compute_single_de_raw, fig.width = 8, fig.height = 6}
treatment_samples <- "Staurosporine_0.1"
control_samples <- "DMSO_0"
combined_lv_nobatch <- compute_single_de(combined, treatment_samples, control_samples, method =  "limma_voom")
plot_volcano(combined_lv_nobatch, max.overlaps = 10)

```

Then, we compare with the volcano plot after batch correction.


```{r multi_plates_compute_single_de, fig.width = 8, fig.height = 6}
treatment_samples <- "Staurosporine_0.1"
control_samples <- "DMSO_0"
subset <- combined[, grepl(paste0(treatment_samples, "|", control_samples), combined$combined_id)]
batch <- subset$orig.ident
combined_lv <- compute_single_de(combined, treatment_samples, control_samples, method = "limma_voom", batch = batch)
plot_volcano(combined_lv)

```

Check CPM levels for top 6 differentially expressed genes.

```{r multiplate_plot_counts, fig.width = 8, fig.height = 6}
genes <- combined_lv$gene[1:6]
group_by <- "combined_id"
plot_counts(combined,genes, group_by, treatment_samples, control_samples, normalisation = "cpm")

```

Summarise the outputs from single comparison in a table

```{r}
summarise_de(combined_lv, lfc_threshold = 1, padj_threshold = 0.01, multi=FALSE)
```

#### 1.3 Multi-comparison DE analysis 

We compare all treatment conditions against the DMSO control. This is especially useful for screening multiple drugs across the plates.

For visualisation purpose, we only use high concentration treatments in this workshop. 

```{r}
treatments <- combined %>%
  filter(Concentration_1 == 10) %>%
  select(combined_id) %>%
  filter(!grepl("DMSO", combined_id)) %>%
  pull() %>%
  unique()
combined <- compute_multi_de(combined, treatments, control_samples = "DMSO_0", method = "edgeR", num_cores = 2, batch = batch)
```

Summarise the outputs from single comparison in a table

```{r}
summarise_de(combined, lfc_threshold = 1, padj_threshold = 0.01, multi=TRUE)
```


Similar to single plate analysis, we can also use this heatmap shows shared differentially expressed genes with corresponding log2FC values.

```{r mutli_plates_plot_multi_de, fig.width=10, fig.height=6}
plot_multi_de(combined, group_by = "combined_id", value = "log2FC", p_value_cutoff = 0.01, direction="up", n_genes = 5, control = "DMSO_0", by="fc")

```
